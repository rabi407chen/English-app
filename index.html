<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>AI è‹±æ–‡å…¨èƒ½åŠ©æ‰‹ (V9.0 Geminiç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/cn2t.js"></script>
    <style>
        :root { --primary: #2563eb; --secondary: #f3f4f6; --text-dark: #1f2937; --text-gray: #6b7280; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { font-family: system-ui, sans-serif; background: #f8fafc; color: var(--text-dark); margin: 0; padding: 0 0 150px 0; line-height: 1.6; user-select: none; -webkit-user-select: none; }
        header { background: white; padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--primary); cursor: pointer; }
        .nav-btn { background: var(--secondary); border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; }
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); text-align: center; }
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 0.75rem; padding: 3rem; cursor: pointer; position: relative; transition: 0.2s; }
        .upload-area:hover { border-color: var(--primary); background: #eff6ff; }
        input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .action-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer; transition: 0.2s; background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-dark); }
        .btn-success { background: var(--success); color: white; }
        
        /* é–±è®€å€ */
        #result-container { text-align: left; font-size: 1.15rem; line-height: 2; display: none; user-select: text; -webkit-user-select: text; }
        .paragraph { margin-bottom: 1.5rem; text-align: justify; }
        .word { cursor: pointer; border-bottom: 1px dotted transparent; transition: 0.2s; }
        .word:hover { background: #eff6ff; color: var(--primary); border-bottom-color: var(--primary); }
        .def-word { cursor: pointer; border-bottom: 1px dotted #ccc; }
        
        /* AI ç¿»è­¯å€ */
        #ai-translation-box { display: none; margin-top: 2rem; padding: 1.5rem; background: #fff7ed; border-left: 5px solid var(--warning); text-align: left; border-radius: 0.5rem; }
        #ai-vocab-list { display: none; margin-top: 2rem; text-align: left; }
        .ai-vocab-item { background: var(--secondary); padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* å´é‚Šæ¬„ & å½ˆçª— */
        .drawer { position: fixed; top: 0; right: -100%; width: 300px; height: 100vh; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: 0.3s; z-index: 200; display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-header { padding: 1rem; background: var(--primary); color: white; position: relative; }
        .drawer-close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .list-item { background: var(--secondary); padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; position: relative; }
        .delete-btn { position: absolute; top: 5px; right: 10px; color: #999; cursor: pointer; }
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 300; }
        .modal-content { background: white; padding: 2rem; width: 90%; max-width: 500px; border-radius: 1rem; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; cursor: pointer; }
        
        #console-log { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: #222; color: lime; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; z-index: 999; opacity: 0.8; display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="location.reload()">ğŸš€ AI è‹±æ–‡åŠ©æ‰‹ (Gemini)</div>
        <button class="nav-btn" onclick="toggleDrawer()">ğŸ“‚ å–®å­—æœ¬ (<span id="vocab-count">0</span>)</button>
    </header>

    <div class="container">
        <div id="upload-card" class="card">
            <h2 style="color:var(--primary); margin-bottom:0.5rem;">AI æ™ºæ…§é–±è®€</h2>
            <p style="color:var(--text-gray); font-size:0.9rem; margin-bottom:2rem;">ä¸Šå‚³é›œèªŒæˆ–æ–‡ç« åœ–ç‰‡ï¼ŒGemini æœƒè‡ªå‹•æ’ç‰ˆã€ç¿»è­¯ä¸¦è§£æã€‚</p>
            
            <div class="upload-area">
                <div style="font-size: 3rem;">ğŸ¤–</div>
                <h3>é»æ“Šä¸Šå‚³åœ–ç‰‡ (è‡ªå‹•åˆ†æ)</h3>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div style="margin-top:2rem;">
                <button class="action-btn btn-outline" onclick="toggleManualInput()">æˆ– æ‰‹å‹•è²¼ä¸Šæ–‡å­—</button>
            </div>
            
            <div id="manual-input-area" style="display:none; margin-top:1rem;">
                <textarea id="manualText" style="width:100%; height:150px; padding:10px; border:1px solid #ccc; border-radius:5px;" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ–‡ç« ..."></textarea>
                <button class="action-btn" style="margin-top:10px;" onclick="processManualText()">é–‹å§‹é–±è®€</button>
            </div>

            <div id="status" style="margin-top:1rem; font-weight:bold;"></div>
        </div>

        <div id="result-card" class="card" style="display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:1rem; margin-bottom:1rem;">
                <h3 style="margin:0;">ğŸ“– è‹±æ–‡åŸæ–‡</h3>
                <button class="action-btn btn-success" onclick="saveCurrentArticle()" style="padding:0.4rem 1rem;">ğŸ’¾ å­˜æª”</button>
            </div>
            
            <div id="result-container"></div>

            <div id="ai-translation-box">
                <h4 style="margin-top:0; color:var(--warning);">ğŸ¤– AI å…¨æ–‡ç¿»è­¯</h4>
                <div id="ai-translation-text"></div>
            </div>

            <div id="ai-vocab-list">
                <h4 style="color:var(--primary);">ğŸ’¡ AI æ¨è–¦å­¸ç¿’å–®å­—</h4>
                <div id="ai-vocab-items"></div>
            </div>
        </div>
    </div>

    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <h3>ğŸ“– æˆ‘çš„å–®å­—æœ¬</h3>
            <span class="drawer-close" onclick="toggleDrawer()">&times;</span>
        </div>
        <div class="drawer-content" id="vocab-list"></div>
        <div style="padding:1rem; border-top:1px solid #eee;">
            <button class="action-btn btn-outline" onclick="exportToCSV()" style="width:100%;">ğŸ“¤ åŒ¯å‡º Excel</button>
            <button class="action-btn btn-outline" onclick="clearVocab()" style="width:100%; margin-top:10px; color:red; border-color:red;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div id="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal()">&times;</span><div id="modal-body"></div></div></div>
    <div id="console-log"></div>

    <script>
        // ==========================================
        // âš ï¸ è«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆä½ çš„ Vercel ç¶²å€ (å¾Œé¢è¦ä¿ç•™ /api/gemini)
        const BACKEND_URL = 'https://english-gemini-backend.vercel.app/api/gemini'; 
        // ==========================================

        const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
        let savedVocab = JSON.parse(localStorage.getItem('myVocab') || '[]');
        let savedArticles = JSON.parse(localStorage.getItem('myArticles') || '[]');
        let currentArticleText = "";

        // UI å…ƒç´ 
        const imageInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const uploadCard = document.getElementById('upload-card');
        const resultCard = document.getElementById('result-card');
        const resultContainer = document.getElementById('result-container');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const drawer = document.getElementById('drawer');
        const vocabCount = document.getElementById('vocab-count');

        updateVocabUI();

        // 1. ä¸Šå‚³åœ–ç‰‡ -> å‘¼å« Vercel Gemini
        imageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            status.innerHTML = `<div class="loader"></div><p>AI æ­£åœ¨é–±è®€ä¸¦åˆ†æåœ–ç‰‡ï¼Œè«‹ç¨å€™ (ç´„ 5-10 ç§’)...</p>`;
            
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Server Error");

                const data = await response.json();
                
                // è™•ç† Gemini å›å‚³çš„è³‡æ–™
                if (data.english) {
                    showResult(data);
                } else {
                    throw new Error("AI ç„¡æ³•è¾¨è­˜å…§å®¹");
                }

            } catch (err) {
                console.error(err);
                status.innerHTML = `<p style="color:red;">ç™¼ç”ŸéŒ¯èª¤: ${err.message}<br>è«‹ç¢ºèª Vercel ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚</p>`;
            }
        });

        // 2. é¡¯ç¤ºçµæœ
        function showResult(data) {
            uploadCard.style.display = 'none';
            resultCard.style.display = 'block';
            status.innerHTML = '';

            // A. é¡¯ç¤ºè‹±æ–‡ (å¯é»æ“Š)
            currentArticleText = data.english;
            displayInteractiveText(data.english);

            // B. é¡¯ç¤ºç¿»è­¯
            if (data.chinese) {
                document.getElementById('ai-translation-box').style.display = 'block';
                document.getElementById('ai-translation-text').innerText = converter(data.chinese);
            }

            // C. é¡¯ç¤º AI æ¨è–¦å–®å­—
            if (data.vocab && data.vocab.length > 0) {
                document.getElementById('ai-vocab-list').style.display = 'block';
                const vocabDiv = document.getElementById('ai-vocab-items');
                vocabDiv.innerHTML = '';
                data.vocab.forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'ai-vocab-item';
                    div.innerHTML = `
                        <div>
                            <strong>${v.word}</strong> <span style="color:#666; font-size:0.9em;">${v.part}</span><br>
                            <span style="font-size:0.9em;">${converter(v.trans)}</span>
                        </div>
                        <button class="action-btn" style="padding:5px 10px; font-size:0.8em;" onclick="quickSave('${v.word}', '${v.trans}')">ï¼‹ æ”¶è—</button>
                    `;
                    vocabDiv.appendChild(div);
                });
            }
        }

        // 3. è‹±æ–‡äº’å‹•é¡¯ç¤º (é»æ“ŠæŸ¥å–®å­—)
        function displayInteractiveText(text) {
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '';
            // ç°¡å–®åˆ†æ®µ
            const paragraphs = text.split(/\n\s*\n/);
            
            paragraphs.forEach(p => {
                const pDiv = document.createElement('div');
                pDiv.className = 'paragraph';
                p.split(/(\s+)/).forEach(w => {
                    const span = document.createElement('span');
                    span.innerText = w;
                    const clean = w.replace(/[^a-zA-Z]/g, "");
                    if (clean.length > 0) {
                        span.className = 'word';
                        span.onclick = () => lookupWord(clean);
                    }
                    pDiv.appendChild(span);
                });
                resultContainer.appendChild(pDiv);
            });
        }

        // 4. æŸ¥å–®å­— (ä¿æŒåŸæœ¬é‚è¼¯)
        async function lookupWord(text) {
            const q = text.replace(/[^a-zA-Z\s]/g, "").trim(); 
            if(!q) return;
            modal.style.display = 'flex';
            modalBody.innerHTML = `<div class="loader"></div>`;
            
            try {
                const [resEn, resZh] = await Promise.all([
                    fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${q}`),
                    fetch(`https://api.mymemory.translated.net/get?q=${q}&langpair=en|zh-TW`)
                ]);
                
                const zhData = await resZh.json();
                let zhText = zhData.responseData?.translatedText || "å¤±æ•—";
                if(!/[\u4e00-\u9fa5]/.test(zhText) && zhData.matches) {
                    const match = zhData.matches.find(m => /[\u4e00-\u9fa5]/.test(m.translation));
                    if(match) zhText = match.translation;
                }
                zhText = converter(zhText);

                // UI
                let html = `
                    <div style="display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <h2 style="margin:0; color:var(--primary);">${q}</h2>
                        <button onclick="speak('${q}')" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">ğŸ”Š</button>
                        <div style="flex:1;"></div>
                        <button class="action-btn" onclick="quickSave('${q}', '${zhText}')">â˜… æ”¶è—</button>
                    </div>
                    <div style="background:#fff7ed; padding:10px; border-radius:5px; margin-bottom:15px;">
                        <strong>${zhText}</strong>
                    </div>
                `;

                if(resEn.ok) {
                    const enData = await resEn.json();
                    enData[0].meanings.forEach(m => {
                        html += `<div style="margin-bottom:10px;">
                            <span style="background:#eff6ff; padding:2px 6px; border-radius:4px; font-size:0.9em; font-weight:bold; color:var(--primary);">${m.partOfSpeech}</span>`;
                        m.definitions.slice(0, 2).forEach((d, i) => {
                            html += `<div style="margin:5px 0 0 5px; font-size:0.95em;">${i+1}. ${makeDefInteractive(d.definition)}</div>`;
                        });
                        html += `</div>`;
                    });
                }
                modalBody.innerHTML = html;

            } catch(e) {
                modalBody.innerHTML = "æŸ¥è©¢å¤±æ•—";
            }
        }

        // éè¿´æŸ¥è©¢ helper
        function makeDefInteractive(text) {
            return text.split(/(\s+)/).map(part => {
                const word = part.replace(/[^a-zA-Z]/g, "");
                if(word) return `<span class="def-word" onclick="lookupWord('${word}')">${part}</span>`;
                return part;
            }).join('');
        }

        // 5. è¼”åŠ©åŠŸèƒ½
        function quickSave(word, mean) {
            if(!savedVocab.some(i => i.word.toLowerCase() === word.toLowerCase())) {
                savedVocab.push({ word, meaning: mean, date: new Date().toLocaleDateString() });
                localStorage.setItem('myVocab', JSON.stringify(savedVocab));
                updateVocabUI();
                alert(`å·²æ”¶è—: ${word}`);
            } else {
                alert("é€™å€‹å­—å·²ç¶“åœ¨å–®å­—æœ¬å›‰ï¼");
            }
        }

        function updateVocabUI() {
            const list = document.getElementById('vocab-list');
            list.innerHTML = '';
            document.getElementById('vocab-count').innerText = savedVocab.length;
            [...savedVocab].reverse().forEach(v => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="delete-btn" onclick="deleteVocab('${v.word}')">&times;</div>
                    <strong onclick="lookupWord('${v.word}')" style="cursor:pointer; color:var(--primary);">${v.word}</strong>
                    <div style="font-size:0.9em; color:#666;">${v.meaning}</div>
                `;
                list.appendChild(div);
            });
        }

        function deleteVocab(w) {
            if(confirm('åˆªé™¤?')) {
                savedVocab = savedVocab.filter(v => v.word !== w);
                localStorage.setItem('myVocab', JSON.stringify(savedVocab));
                updateVocabUI();
            }
        }

        function clearVocab() { if(confirm('æ¸…ç©ºå…¨éƒ¨?')) { savedVocab = []; localStorage.setItem('myVocab', '[]'); updateVocabUI(); } }
        
        function saveCurrentArticle() {
            if(!currentArticleText) return;
            const title = prompt("æ–‡ç« æ¨™é¡Œ:", "AI é–±è®€ç­†è¨˜");
            if(title) {
                savedArticles.unshift({ id: Date.now(), title, content: currentArticleText, date: new Date().toLocaleDateString() });
                localStorage.setItem('myArticles', JSON.stringify(savedArticles));
                alert("å·²å­˜æª”ï¼(å¯åœ¨å´é‚Šæ¬„æŸ¥çœ‹)");
            }
        }

        function exportToCSV() {
            if(!savedVocab.length) return alert("æ²’å–®å­—");
            let csv = "\uFEFFå–®å­—,è§£é‡‹,æ—¥æœŸ\n";
            savedVocab.forEach(v => csv += `${v.word},${v.meaning},${v.date}\n`);
            const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            const a = document.createElement('a'); a.href = url; a.download = 'vocab.csv'; a.click();
        }

        function toggleManualInput() {
            const div = document.getElementById('manual-input-area');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        function processManualText() {
            const text = document.getElementById('manualText').value;
            if(!text) return;
            showResult({ english: text, chinese: null, vocab: [] }); // æ‰‹å‹•æ¨¡å¼æ²’æœ‰ AI ç¿»è­¯
        }

        function speak(w) { const u = new SpeechSynthesisUtterance(w); u.lang='en-US'; window.speechSynthesis.speak(u); }
        function toggleDrawer() { drawer.classList.toggle('open'); }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = e => { if(e.target==modal) closeModal(); };

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('sw.js')); }
    </script>
</body>
</html>
