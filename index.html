<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>AI è‹±æ–‡å…¨èƒ½åŠ©æ‰‹ (V9.1 å®Œæ•´ç‰ˆ)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/cn2t.js"></script>

    <style>
        /* === åŸºç¤è®Šæ•¸èˆ‡é‡ç½® === */
        :root { --primary: #2563eb; --primary-hover: #1d4ed8; --secondary: #f3f4f6; --text-dark: #1f2937; --text-gray: #6b7280; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: var(--text-dark); margin: 0; padding: 0; line-height: 1.6; user-select: none; -webkit-user-select: none; padding-bottom: 150px; }
        
        /* === å°èˆªæ¬„ === */
        header { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .nav-btn { background: var(--secondary); border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; color: var(--text-dark); display: flex; align-items: center; gap: 0.5rem; }

        /* === ä¸»å®¹å™¨ === */
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 2rem; margin-bottom: 2rem; text-align: center; position: relative; }
        
        /* === ä¸Šå‚³èˆ‡è¼¸å…¥å€ === */
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 0.75rem; padding: 3rem; transition: border-color 0.2s; cursor: pointer; position: relative; background: #fafafa; }
        .upload-area:hover { border-color: var(--primary); background: #eff6ff; }
        input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        #manual-input-area { display: none; margin-top: 1rem; text-align: left; }
        textarea { width: 100%; height: 150px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box; }
        
        /* === é–±è®€çµæœå€ === */
        #result-container { text-align: left; font-size: 1.15rem; line-height: 2; color: #374151; display: none; user-select: text; -webkit-user-select: text; /* å…è¨±é¸å–æ–‡å­— */ }
        .paragraph { margin-bottom: 1.5rem; text-align: justify; text-indent: 2rem; }
        .word { cursor: pointer; border-bottom: 1px dotted transparent; transition: all 0.2s; }
        .word:hover { background-color: #eff6ff; color: var(--primary); border-bottom-color: var(--primary); }
        
        /* éè¿´æŸ¥è©¢å–®å­—æ¨£å¼ */
        .def-word { cursor: pointer; color: var(--text-dark); transition: color 0.2s; border-bottom: 1px dotted #ccc; }
        .def-word:hover { color: var(--primary); background-color: #eff6ff; border-bottom-color: var(--primary); }

        /* AI ç¿»è­¯èˆ‡å–®å­—å€ */
        #ai-translation-box { display: none; margin-top: 2rem; padding: 1.5rem; background: #fff7ed; border-left: 5px solid var(--warning); text-align: left; border-radius: 0.5rem; font-size: 1rem; }
        #ai-vocab-list { display: none; margin-top: 2rem; text-align: left; }
        .ai-vocab-item { background: var(--secondary); padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* === å´é‚Šæ¬„ === */
        .drawer { position: fixed; top: 0; right: -400px; width: 350px; height: 100vh; background: white; box-shadow: -4px 0 15px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 200; display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-header { padding: 0; border-bottom: 1px solid #e5e7eb; background: var(--primary); color: white; position: relative; }
        .drawer-close { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5rem; color: white; z-index: 999; line-height: 1; }
        
        .tabs { display: flex; width: 100%; }
        .tab { flex: 1; padding: 1rem; text-align: center; cursor: pointer; font-weight: bold; opacity: 0.7; transition: 0.2s; background: rgba(0,0,0,0.1); }
        .tab.active { background: white; color: var(--primary); opacity: 1; border-top: 3px solid white; }
        
        .drawer-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .list-item { background: var(--secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; position: relative; cursor: pointer; }
        .item-title { font-weight: bold; color: var(--primary); font-size: 1.1em; }
        .item-sub { font-size: 0.85em; color: var(--text-gray); margin-top: 0.25rem; }
        .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; color: #9ca3af; cursor: pointer; font-size: 1.2rem; }
        
        /* === æŒ‰éˆ•æ¨£å¼ === */
        .action-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-dark); }
        .btn-success { background: var(--success); color: white; }
        
        /* === å½ˆçª— & Loader === */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; position: relative; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .close-modal { position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 600px) { .drawer { width: 100%; right: -100%; } }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="location.reload()">ğŸš€ AI è‹±æ–‡å…¨èƒ½åŠ©æ‰‹</div>
        <button class="nav-btn" onclick="toggleDrawer()">ğŸ“‚ å­¸ç¿’ä¸­å¿ƒ</button>
    </header>

    <div class="container">
        <div id="upload-card" class="card">
            <h2 style="color:var(--primary); margin-bottom:0.5rem;">AI æ™ºæ…§é–±è®€ (Gemini)</h2>
            <p style="color:var(--text-gray); font-size:0.9rem; margin-bottom:2rem;">æ”¯æ´å¤šæ¬„ä½é›œèªŒã€æ‰‹å¯«ç­†è¨˜ï¼Œè‡ªå‹•æ’ç‰ˆèˆ‡ç¿»è­¯ã€‚</p>
            
            <div class="upload-area">
                <div style="font-size: 3rem;">ğŸ“·</div>
                <h3>é»æ“Šä¸Šå‚³åœ–ç‰‡</h3>
                <p style="color:gray; font-size:0.9rem;">è‡ªå‹•è­˜åˆ¥ç‰ˆé¢ï¼Œç„¡éœ€æ‰‹å‹•åˆ‡åœ–</p>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div style="margin-top:2rem;">
                <button class="action-btn btn-outline" style="width:auto;" onclick="toggleManualInput()">ğŸ“ æˆ– æ‰‹å‹•è²¼ä¸Šæ–‡å­—</button>
            </div>
            
            <div id="manual-input-area">
                <textarea id="manualText" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šè‹±æ–‡æ–‡ç« ..."></textarea>
                <button class="action-btn btn-primary" style="margin-top:10px;" onclick="processManualText()">é–‹å§‹é–±è®€</button>
            </div>

            <div id="status" style="margin-top:1.5rem; font-weight:bold;"></div>
        </div>

        <div id="result-card" class="card" style="display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:1rem; margin-bottom:1rem;">
                <h3 style="margin:0; color:var(--primary);">ğŸ“– é–±è®€æ¨¡å¼</h3>
                <button class="action-btn btn-success" onclick="saveCurrentArticle()" style="width:auto; padding:0.4rem 1rem;">ğŸ’¾ å­˜æª”</button>
            </div>
            
            <div id="result-container"></div>

            <div id="ai-translation-box">
                <h4 style="margin-top:0; color:var(--warning);">ğŸ¤– AI å…¨æ–‡ç¿»è­¯</h4>
                <div id="ai-translation-text"></div>
            </div>

            <div id="ai-vocab-list">
                <h4 style="color:var(--primary);">ğŸ’¡ AI æ¨è–¦å­¸ç¿’å–®å­—</h4>
                <div id="ai-vocab-items"></div>
            </div>
        </div>
    </div>

    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('vocab')" id="tab-vocab">å–®å­—æœ¬ (<span id="vocab-count">0</span>)</div>
                <div class="tab" onclick="switchTab('article')" id="tab-article">æ–‡ç« åº«</div>
            </div>
            <span class="drawer-close" onclick="toggleDrawer()">&times;</span>
        </div>
        <div class="drawer-content">
            <div id="vocab-content" class="tab-content active">
                <div id="vocab-list"></div>
                <div style="margin-top:2rem;">
                     <button class="action-btn btn-primary" onclick="exportToCSV()">ğŸ“¤ åŒ¯å‡º CSV</button>
                     <button class="action-btn btn-outline" onclick="clearVocab()" style="width:100%; margin-top:10px; color:var(--danger); border-color:var(--danger);">ğŸ—‘ï¸ æ¸…ç©ºå–®å­—</button>
                </div>
            </div>
            <div id="article-content" class="tab-content">
                <div id="article-list"></div>
                <div style="margin-top:2rem;">
                     <button class="action-btn btn-outline" onclick="clearArticles()" style="width:100%; color:var(--danger); border-color:var(--danger);">ğŸ—‘ï¸ æ¸…ç©ºæ–‡ç« </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal()">&times;</span><div id="modal-body"></div></div></div>

    <script>
        // ==========================================
        // âš ï¸ è«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆä½ çš„ Vercel ç¶²å€ (å¾Œé¢è¦ä¿ç•™ /api/gemini)
        const BACKEND_URL = 'https://english-gemini-backend.vercel.app/api/gemini'; 
        // ==========================================

        const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });
        let savedVocab = JSON.parse(localStorage.getItem('myVocab') || '[]');
        let savedArticles = JSON.parse(localStorage.getItem('myArticles') || '[]');
        let currentArticleText = "";
        let currentArticleId = null;

        // UI å…ƒç´ 
        const imageInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const uploadCard = document.getElementById('upload-card');
        const resultCard = document.getElementById('result-card');
        const resultContainer = document.getElementById('result-container');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const drawer = document.getElementById('drawer');
        const vocabCount = document.getElementById('vocab-count');

        updateVocabUI();
        updateArticleUI();

        // 1. ä¸Šå‚³åœ–ç‰‡ -> å‘¼å« Vercel Gemini
        imageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            status.innerHTML = `<div class="loader"></div><p>AI æ­£åœ¨é–±è®€ä¸¦åˆ†æåœ–ç‰‡ (ç´„ 5-8 ç§’)...</p>`;
            
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("API é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥ Vercel ç‹€æ…‹)");

                const data = await response.json();
                
                if (data.english) {
                    currentArticleId = null; // æ–°æ–‡ç« é‡ç½® ID
                    showResult(data);
                } else {
                    throw new Error("AI ç„¡æ³•è¾¨è­˜å…§å®¹æˆ–æ ¼å¼éŒ¯èª¤");
                }

            } catch (err) {
                console.error(err);
                status.innerHTML = `<p style="color:red;">ç™¼ç”ŸéŒ¯èª¤: ${err.message}</p>`;
            }
        });

        // 2. é¡¯ç¤ºçµæœ
        function showResult(data) {
            uploadCard.style.display = 'none';
            resultCard.style.display = 'block';
            status.innerHTML = '';

            // A. é¡¯ç¤ºè‹±æ–‡ (å¯é»æ“Š)
            currentArticleText = data.english;
            displayInteractiveText(data.english);

            // B. é¡¯ç¤ºç¿»è­¯
            if (data.chinese) {
                document.getElementById('ai-translation-box').style.display = 'block';
                document.getElementById('ai-translation-text').innerText = converter(data.chinese);
            } else {
                document.getElementById('ai-translation-box').style.display = 'none';
            }

            // C. é¡¯ç¤º AI æ¨è–¦å–®å­—
            if (data.vocab && data.vocab.length > 0) {
                document.getElementById('ai-vocab-list').style.display = 'block';
                const vocabDiv = document.getElementById('ai-vocab-items');
                vocabDiv.innerHTML = '';
                data.vocab.forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'ai-vocab-item';
                    div.innerHTML = `
                        <div>
                            <strong>${v.word}</strong> <span style="color:#666; font-size:0.9em;">${v.part}</span><br>
                            <span style="font-size:0.9em;">${converter(v.trans)}</span>
                        </div>
                        <button class="action-btn btn-outline" style="padding:5px 10px; width:auto;" onclick="quickSave('${v.word}', '${v.trans}')">ï¼‹ æ”¶è—</button>
                    `;
                    vocabDiv.appendChild(div);
                });
            } else {
                document.getElementById('ai-vocab-list').style.display = 'none';
            }
        }

        // 3. è‹±æ–‡äº’å‹•é¡¯ç¤º (é»æ“Š + ç‰‡èªåç™½)
        function displayInteractiveText(text) {
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '';
            const paragraphs = text.split(/\n\s*\n/);
            
            paragraphs.forEach(p => {
                const pDiv = document.createElement('div');
                pDiv.className = 'paragraph';
                p.split(/(\s+)/).forEach(w => {
                    const span = document.createElement('span');
                    span.innerText = w;
                    const clean = w.replace(/[^a-zA-Z]/g, "");
                    if (clean.length > 0) {
                        span.className = 'word';
                        span.onclick = (e) => {
                            e.stopPropagation(); // é˜²æ­¢åç™½è§¸ç™¼
                            lookupWord(clean);
                        };
                    }
                    pDiv.appendChild(span);
                });
                resultContainer.appendChild(pDiv);
            });
        }

        // ğŸ”¥ ç‰‡èªåç™½ç›£è½
        resultContainer.addEventListener('mouseup', handleSelection);
        resultContainer.addEventListener('touchend', handleSelection);

        function handleSelection() {
            setTimeout(() => {
                const selection = window.getSelection();
                const text = selection.toString().trim();
                // è¦å‰‡ï¼šæœ‰å…§å®¹ï¼Œæœ‰ç©ºæ ¼(ç‰‡èª)ï¼Œé•·åº¦ä¸è¶…é6å€‹å­—
                if (text.length > 0 && text.indexOf(' ') > -1 && text.split(' ').length <= 6) {
                    lookupWord(text);
                    selection.removeAllRanges();
                }
            }, 100);
        }

        // 4. æŸ¥å–®å­— (å«éè¿´æŸ¥è©¢)
        async function lookupWord(text) {
            const q = text.replace(/[^a-zA-Z\s]/g, "").trim(); 
            if(!q) return;
            
            modal.style.display = 'flex';
            modalBody.innerHTML = `<div class="loader"></div><p style="text-align:center">æŸ¥è©¢ä¸­: ${q}</p>`;
            
            try {
                const [resEn, resZh] = await Promise.all([
                    fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${q}`),
                    fetch(`https://api.mymemory.translated.net/get?q=${q}&langpair=en|zh-TW`)
                ]);
                
                const zhData = await resZh.json();
                let zhText = zhData.responseData?.translatedText || "ç¿»è­¯å¤±æ•—";
                if(!/[\u4e00-\u9fa5]/.test(zhText) && zhData.matches) {
                    const match = zhData.matches.find(m => /[\u4e00-\u9fa5]/.test(m.translation));
                    if(match) zhText = match.translation;
                }
                zhText = converter(zhText);

                const isSaved = savedVocab.some(i => i.word.toLowerCase() === q.toLowerCase());
                const starBtnText = isSaved ? 'â­ å·²æ”¶è—' : 'â˜† æ”¶è—';
                const starBtnClass = isSaved ? 'btn-primary' : 'btn-outline';

                let html = `
                    <div style="display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                        <h2 style="margin:0; color:var(--primary);">${q}</h2>
                        <button onclick="speak('${q}')" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">ğŸ”Š</button>
                        <div style="flex:1;"></div>
                        <button class="action-btn ${starBtnClass}" style="width:auto;" onclick="quickSave('${q}', '${zhText}')">${starBtnText}</button>
                    </div>
                    <div style="background:#fff7ed; padding:10px; border-radius:5px; margin-bottom:15px; border-left:4px solid var(--warning);">
                        <strong>${zhText}</strong>
                    </div>
                `;

                if(resEn.ok) {
                    const enData = await resEn.json();
                    enData[0].meanings.forEach(m => {
                        html += `<div style="margin-bottom:10px;">
                            <span style="background:#eff6ff; padding:2px 6px; border-radius:4px; font-size:0.9em; font-weight:bold; color:var(--primary);">${m.partOfSpeech}</span>`;
                        m.definitions.slice(0, 2).forEach((d, i) => {
                            html += `<div style="margin:5px 0 0 5px; font-size:0.95em;">${i+1}. ${makeDefInteractive(d.definition)}</div>`;
                        });
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color:gray; font-size:0.9rem;">(æ­¤ç‚ºçµ„åˆè©æˆ–ç‰‡èªï¼Œåƒ…æä¾›ç¿»è­¯)</p>`;
                }
                modalBody.innerHTML = html;

            } catch(e) {
                modalBody.innerHTML = "<p>æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>";
            }
        }

        // è¼”åŠ©ï¼šè§£é‡‹æ–‡å­—è½‰äº’å‹•
        function makeDefInteractive(text) {
            return text.split(/(\s+)/).map(part => {
                const word = part.replace(/[^a-zA-Z]/g, "");
                if(word) return `<span class="def-word" onclick="lookupWord('${word}')">${part}</span>`;
                return part;
            }).join('');
        }

        // 5. è³‡æ–™å­˜å–èˆ‡ç®¡ç†
        function quickSave(word, mean) {
            if(!savedVocab.some(i => i.word.toLowerCase() === word.toLowerCase())) {
                savedVocab.push({ word, meaning: mean, date: new Date().toLocaleDateString() });
                localStorage.setItem('myVocab', JSON.stringify(savedVocab));
                updateVocabUI();
                alert(`å·²æ”¶è—: ${word}`);
                closeModal();
            } else {
                alert("å–®å­—å·²å­˜åœ¨ï¼");
            }
        }

        function saveCurrentArticle() {
            if(!currentArticleText) return;
            
            // è¦†å¯«é‚è¼¯
            if (currentArticleId) {
                const idx = savedArticles.findIndex(a => a.id == currentArticleId);
                if (idx !== -1) {
                    if(confirm(`è¦è¦†å¯«æ–‡ç« ã€Œ${savedArticles[idx].title}ã€å—ï¼Ÿ\n(å–æ¶ˆå‰‡å¦å­˜æ–°æª”)`)) {
                        savedArticles[idx].content = currentArticleText;
                        savedArticles[idx].date = new Date().toLocaleDateString();
                        localStorage.setItem('myArticles', JSON.stringify(savedArticles));
                        updateArticleUI();
                        alert("å·²æ›´æ–°ï¼");
                        return;
                    }
                }
            }

            const title = prompt("è«‹è¼¸å…¥æ–‡ç« æ¨™é¡Œ:", "AI é–±è®€ç­†è¨˜");
            if(title) {
                const newId = Date.now();
                savedArticles.unshift({ id: newId, title, content: currentArticleText, date: new Date().toLocaleDateString() });
                localStorage.setItem('myArticles', JSON.stringify(savedArticles));
                updateArticleUI();
                currentArticleId = newId;
                alert("å·²å­˜æª”ï¼");
            }
        }

        function loadArticle(id) {
            const article = savedArticles.find(a => a.id == id);
            if (article) {
                currentArticleId = id;
                showResult({ english: article.content, chinese: null, vocab: [] });
                toggleDrawer();
            }
        }

        function updateVocabUI() {
            const list = document.getElementById('vocab-list');
            list.innerHTML = '';
            document.getElementById('vocab-count').innerText = savedVocab.length;
            if(!savedVocab.length) { list.innerHTML = '<div style="text-align:center; color:gray; margin-top:2rem;">ç„¡å–®å­—</div>'; return; }
            [...savedVocab].reverse().forEach(v => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="delete-btn" onclick="deleteVocab('${v.word}', event)">&times;</div>
                    <strong onclick="lookupWord('${v.word}')" style="cursor:pointer; color:var(--primary);">${v.word}</strong>
                    <div style="font-size:0.9em; color:#666;">${v.meaning}</div>
                `;
                list.appendChild(div);
            });
        }

        function updateArticleUI() {
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            if(!savedArticles.length) { list.innerHTML = '<div style="text-align:center; color:gray; margin-top:2rem;">ç„¡æ–‡ç« </div>'; return; }
            savedArticles.forEach(a => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="delete-btn" onclick="deleteArticle(${a.id}, event)">&times;</div>
                    <strong style="color:var(--primary);">${a.title}</strong>
                    <div style="font-size:0.85em; color:#666;">${a.date} Â· å­—æ•¸: ${a.content.length}</div>
                `;
                div.onclick = () => loadArticle(a.id);
                list.appendChild(div);
            });
        }

        function deleteVocab(w, e) { e.stopPropagation(); if(confirm('åˆªé™¤å–®å­—?')) { savedVocab = savedVocab.filter(v => v.word !== w); localStorage.setItem('myVocab', JSON.stringify(savedVocab)); updateVocabUI(); } }
        function clearVocab() { if(confirm('æ¸…ç©ºæ‰€æœ‰å–®å­—?')) { savedVocab = []; localStorage.setItem('myVocab', '[]'); updateVocabUI(); } }
        function deleteArticle(id, e) { e.stopPropagation(); if(confirm('åˆªé™¤æ–‡ç« ?')) { savedArticles = savedArticles.filter(a => a.id != id); localStorage.setItem('myArticles', JSON.stringify(savedArticles)); updateArticleUI(); } }
        function clearArticles() { if(confirm('æ¸…ç©ºæ‰€æœ‰æ–‡ç« ?')) { savedArticles = []; localStorage.setItem('myArticles', '[]'); updateArticleUI(); } }

        function exportToCSV() {
            if(!savedVocab.length) return alert("ç„¡è³‡æ–™");
            let csv = "\uFEFFå–®å­—,è§£é‡‹,æ—¥æœŸ\n";
            savedVocab.forEach(v => csv += `${v.word},${v.meaning},${v.date}\n`);
            const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            const a = document.createElement('a'); a.href = url; a.download = `Vocab_${new Date().toLocaleDateString()}.csv`; a.click();
        }

        // å…¶ä»–åŠŸèƒ½
        function toggleManualInput() {
            const div = document.getElementById('manual-input-area');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }
        function processManualText() {
            const text = document.getElementById('manualText').value;
            if(!text.trim()) return alert("è«‹è¼¸å…¥å…§å®¹");
            currentArticleId = null;
            showResult({ english: text });
        }
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
        }
        function speak(w) { const u = new SpeechSynthesisUtterance(w); u.lang='en-US'; window.speechSynthesis.speak(u); }
        function toggleDrawer() { drawer.classList.toggle('open'); }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = e => { if(e.target==modal) closeModal(); };

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('sw.js')); }
    </script>
</body>
</html>
