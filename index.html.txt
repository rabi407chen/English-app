<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Anna's AI è‹±æ–‡å°åŠ©æ‰‹ (V7.0)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <style>
        /* åŸºç¤æ¨£å¼ */
        :root { --primary: #2563eb; --primary-hover: #1d4ed8; --secondary: #f3f4f6; --text-dark: #1f2937; --text-gray: #6b7280; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: var(--text-dark); margin: 0; padding: 0; line-height: 1.6; user-select: none; -webkit-user-select: none; padding-bottom: 150px; }
        
        /* å°èˆªèˆ‡ä½ˆå±€ */
        header { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .nav-btn { background: var(--secondary); border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; color: var(--text-dark); display: flex; align-items: center; gap: 0.5rem; }
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 2rem; margin-bottom: 2rem; text-align: center; position: relative; }
        
        /* è¼¸å…¥èˆ‡æ§åˆ¶å€ */
        .upload-area { border: 2px dashed #cbd5e1; border-radius: 0.75rem; padding: 2rem; transition: border-color 0.2s; cursor: pointer; position: relative; }
        .upload-area:hover { border-color: var(--primary); }
        input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .controls { margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; background: var(--secondary); padding: 0.5rem 1rem; border-radius: 2rem; }
        
        /* æ‰‹å‹•è¼¸å…¥å€ (New) */
        #manual-input-area { display: none; margin-top: 1rem; text-align: left; }
        textarea { width: 100%; height: 200px; padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box; }
        
        /* çµæœé¡¯ç¤ºå€ */
        #result-container { text-align: left; font-size: 1.1rem; line-height: 2; color: #374151; display: none; user-select: text; -webkit-user-select: text; }
        .paragraph { margin-bottom: 1.5rem; text-align: justify; text-indent: 2rem; }
        .word { cursor: pointer; border-bottom: 1px dotted transparent; transition: all 0.2s; }
        .word:hover { background-color: #eff6ff; color: var(--primary); border-bottom-color: var(--primary); }
        
        /* å´é‚Šæ¬„ (Tabs Update) */
        .drawer { position: fixed; top: 0; right: -400px; width: 350px; height: 100vh; background: white; box-shadow: -4px 0 15px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 200; display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-header { padding: 0; border-bottom: 1px solid #e5e7eb; background: var(--primary); color: white; }
        
        /* å´é‚Šæ¬„åˆ†é ç±¤ */
        .tabs { display: flex; }
        .tab { flex: 1; padding: 1rem; text-align: center; cursor: pointer; font-weight: bold; opacity: 0.7; transition: 0.2s; background: rgba(0,0,0,0.1); }
        .tab.active { background: white; color: var(--primary); opacity: 1; border-top: 3px solid white; }
        
        .drawer-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* åˆ—è¡¨é …ç›® */
        .list-item { background: var(--secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; position: relative; cursor: pointer; }
        .list-item:hover { background: #e5e7eb; }
        .item-title { font-weight: bold; color: var(--primary); font-size: 1.1em; }
        .item-sub { font-size: 0.85em; color: var(--text-gray); margin-top: 0.25rem; }
        .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; color: #9ca3af; cursor: pointer; font-size: 1.2rem; z-index: 5; }
        .delete-btn:hover { color: var(--danger); }
        
        .drawer-footer { padding: 1rem; border-top: 1px solid #e5e7eb; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .action-btn { width: 100%; padding: 0.75rem; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer; margin-bottom: 0.5rem; transition: background 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-text { background: transparent; color: var(--primary); padding: 0.5rem; width: auto; display: inline-block; }
        
        /* æ¸¬é©—å€ */
        #quiz-card { display: none; text-align: center; }
        .quiz-question { font-size: 2rem; font-weight: bold; color: var(--primary); margin-bottom: 2rem; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .quiz-btn { padding: 1.5rem; font-size: 1.1rem; background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s; color: var(--text-dark); }
        .quiz-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .quiz-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* å½ˆçª— & Log */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; position: relative; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .close-modal { position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
        .debug-img { max-width: 45%; border: 1px solid #ddd; margin: 5px; border-radius: 4px; }
        #console-log { position: fixed; bottom: 0; left: 0; width: 100%; height: 120px; background: #222; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; z-index: 9999; box-sizing: border-box; border-top: 2px solid #444; opacity: 0.9; }
        
        @media (max-width: 600px) { .drawer { width: 100%; right: -100%; } .quiz-options { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="goHome()">ğŸ“š Anna's AI è‹±æ–‡å°åŠ©æ‰‹</div>
        <button class="nav-btn" onclick="toggleDrawer()"><span>ğŸ“‚</span> å­¸ç¿’ä¸­å¿ƒ</button>
    </header>

    <div class="container">
        <div id="quiz-card" class="card">
            <h3 style="color:var(--text-gray); margin-bottom:0.5rem;">ğŸ§  å–®å­—éš¨å ‚æ¸¬é©—</h3>
            <div class="quiz-score">Score: <span id="current-score">0</span> / <span id="total-questions">0</span></div>
            <div id="quiz-game-area">
                <div class="quiz-question" id="quiz-word">Loading...</div>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
            <div id="quiz-result-area" style="display:none;">
                <h2 id="final-score-title" style="font-size:2.5rem; margin:1rem 0;">100åˆ†!</h2>
                <p id="final-comment">å¤ªå²å®³äº†ï¼å…¨éƒ¨ç­”å°ï¼</p>
                <button class="action-btn btn-primary" onclick="startQuiz()" style="width:200px; margin:auto;">ğŸ”„ å†æ¸¬ä¸€æ¬¡</button><br><br>
                <button class="action-btn btn-outline" onclick="goHome()" style="width:200px; margin:auto;">ğŸ  å›åˆ°é¦–é </button>
            </div>
            <button id="quit-quiz-btn" class="action-btn btn-outline" onclick="goHome()" style="width:auto; margin-top:1rem;">âŒ çµæŸæ¸¬é©—</button>
        </div>

        <div id="upload-card" class="card">
            <div style="display:flex; justify-content:center; gap:1rem; margin-bottom:1.5rem;">
                <button id="btn-mode-image" class="action-btn btn-primary" style="width:auto;" onclick="switchInputMode('image')">ğŸ“· åœ–ç‰‡è¾¨è­˜</button>
                <button id="btn-mode-text" class="action-btn btn-outline" style="width:auto;" onclick="switchInputMode('text')">ğŸ“ æ‰‹å‹•è²¼ä¸Š</button>
            </div>

            <div id="image-input-area">
                <div class="upload-area">
                    <div style="font-size: 2rem;">ğŸ“·</div>
                    <h3 style="margin: 0.5rem 0;">é»æ“Šä¸Šå‚³åœ–ç‰‡ æˆ– æ‹–æ›³æª”æ¡ˆ</h3>
                    <p style="color: var(--text-gray); font-size: 0.9rem;">æ”¯æ´ jpg, png</p>
                    <input type="file" id="imageInput" accept="image/*">
                </div>
                <div class="controls">
                    <label class="checkbox-wrapper"><input type="checkbox" id="twoColumnMode" checked> <span>é›™æ¬„æ¨¡å¼</span></label>
                </div>
            </div>

            <div id="manual-input-area">
                <textarea id="manualText" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šè‹±æ–‡æ–‡ç« æˆ–è¼¸å…¥æ–‡å­—..."></textarea>
                <button class="action-btn btn-primary" onclick="processManualText()" style="margin-top:1rem;">ğŸš€ é–‹å§‹é–±è®€</button>
            </div>

            <div id="status"></div>
            <div id="debug-area" style="display:none; margin-top:1rem; padding:1rem; background:#fff1f2; border-radius:0.5rem;">
                <p style="color: var(--danger); font-size:0.9rem; margin:0 0 0.5rem 0;">ğŸ”´ åˆ‡åœ–æª¢æŸ¥</p>
                <div id="debug-images-container"></div>
            </div>
        </div>

        <div id="result-card" class="card" style="display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:1rem;">
                <h3 style="margin:0; color:var(--primary);">ğŸ“– é–±è®€æ¨¡å¼</h3>
                <button class="action-btn btn-success" style="width:auto; padding:0.4rem 1rem; margin:0;" onclick="saveCurrentArticle()">ğŸ’¾ å„²å­˜æ–‡ç« </button>
            </div>
            <div id="result-container"></div>
        </div>
    </div>

    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('vocab')" id="tab-vocab">å–®å­—æœ¬</div>
                <div class="tab" onclick="switchTab('article')" id="tab-article">æ–‡ç« åº«</div>
            </div>
            <span style="position:absolute; top:5px; right:10px; cursor:pointer; font-size:1.5rem; color:white;" onclick="toggleDrawer()">&times;</span>
        </div>
        
        <div class="drawer-content">
            <div id="vocab-content" class="tab-content active">
                <div id="vocab-list"></div>
                <div style="margin-top:2rem;">
                     <button class="action-btn btn-success" onclick="startQuiz()">ğŸ“ é–‹å§‹å–®å­—æ¸¬é©—</button>
                     <button class="action-btn btn-primary" onclick="exportToCSV()">ğŸ“¤ åŒ¯å‡ºå–®å­— CSV</button>
                     <button class="action-btn btn-outline" onclick="clearVocab()" style="color:var(--danger); border-color:var(--danger);">ğŸ—‘ï¸ æ¸…ç©ºå–®å­—</button>
                </div>
            </div>

            <div id="article-content" class="tab-content">
                <div id="article-list"></div>
                <div style="margin-top:2rem;">
                     <button class="action-btn btn-outline" onclick="clearArticles()" style="color:var(--danger); border-color:var(--danger);">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ–‡ç« </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal()">&times;</span><div id="modal-body">è¼‰å…¥ä¸­...</div></div></div>

    <div id="console-log"><div>System Log V7.0 Initialized...</div></div>

    <script>
        // === ç³»çµ±æ—¥èªŒ ===
        function log(msg, type='info') {
            const logBox = document.getElementById('console-log');
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type === 'error') div.style.color = 'red';
            if(type === 'success') div.style.color = '#00ff00';
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(msg);
        }
        window.onerror = function(message) { log(`ERROR: ${message}`, 'error'); };

        // === è¨­å®šèˆ‡è³‡æ–™ ===
        const API_KEY = 'K87721920188957'; 
        let savedVocab = JSON.parse(localStorage.getItem('myVocab') || '[]'); 
        let savedArticles = JSON.parse(localStorage.getItem('myArticles') || '[]'); // æ–°å¢ï¼šæ–‡ç« å­˜æª”
        let currentArticleText = ""; // æš«å­˜ç•¶å‰æ–‡ç« æ–‡å­—

        // æ¸¬é©—è®Šæ•¸
        let quizQuestions = []; let currentQuestionIndex = 0; let score = 0; let isAnswering = false;

        // DOM å…ƒç´ 
        const imageInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const uploadCard = document.getElementById('upload-card');
        const resultCard = document.getElementById('result-card');
        const quizCard = document.getElementById('quiz-card');
        const resultContainer = document.getElementById('result-container');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const drawer = document.getElementById('drawer');
        
        // åˆå§‹åŒ– UI
        updateVocabUI();
        updateArticleUI();

        // === æ¨¡å¼åˆ‡æ›é‚è¼¯ ===
        function switchInputMode(mode) {
            document.getElementById('image-input-area').style.display = mode === 'image' ? 'block' : 'none';
            document.getElementById('manual-input-area').style.display = mode === 'text' ? 'block' : 'none';
            
            document.getElementById('btn-mode-image').className = mode === 'image' ? 'action-btn btn-primary' : 'action-btn btn-outline';
            document.getElementById('btn-mode-text').className = mode === 'text' ? 'action-btn btn-primary' : 'action-btn btn-outline';
        }

        // === æ‰‹å‹•è¼¸å…¥è™•ç† ===
        function processManualText() {
            const text = document.getElementById('manualText').value;
            if (!text.trim()) { alert("è«‹è¼¸å…¥æ–‡å­—ï¼"); return; }
            log("è™•ç†æ‰‹å‹•è¼¸å…¥æ–‡å­—...");
            displayInteractiveText(text);
        }

        // === æ–‡ç« å­˜æª”åŠŸèƒ½ ===
        function saveCurrentArticle() {
            if (!currentArticleText) { alert("æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜"); return; }
            const title = prompt("è«‹ç‚ºé€™ç¯‡æ–‡ç« è¼¸å…¥æ¨™é¡Œï¼š", "æœªå‘½åæ–‡ç« ");
            if (title) {
                const newArticle = {
                    id: Date.now(),
                    title: title,
                    content: currentArticleText,
                    date: new Date().toLocaleDateString()
                };
                savedArticles.unshift(newArticle); // åŠ åˆ°æœ€å‰é¢
                localStorage.setItem('myArticles', JSON.stringify(savedArticles));
                updateArticleUI();
                alert("æ–‡ç« å·²å„²å­˜ï¼è«‹åˆ°ã€Œæ–‡ç« åº«ã€æŸ¥çœ‹ã€‚");
            }
        }

        function loadArticle(id) {
            const article = savedArticles.find(a => a.id == id);
            if (article) {
                log(`è¼‰å…¥æ–‡ç« : ${article.title}`);
                displayInteractiveText(article.content);
                toggleDrawer(); // é—œé–‰å´é‚Šæ¬„
            }
        }

        function deleteArticle(id, event) {
            event.stopPropagation(); // é˜²æ­¢è§¸ç™¼é»æ“Šè¼‰å…¥
            if(confirm("ç¢ºå®šåˆªé™¤é€™ç¯‡æ–‡ç« ï¼Ÿ")) {
                savedArticles = savedArticles.filter(a => a.id != id);
                localStorage.setItem('myArticles', JSON.stringify(savedArticles));
                updateArticleUI();
            }
        }

        function clearArticles() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ–‡ç« ï¼Ÿ")) {
                savedArticles = [];
                localStorage.setItem('myArticles', JSON.stringify(savedArticles));
                updateArticleUI();
            }
        }

        function updateArticleUI() {
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            if (savedArticles.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:gray; margin-top:2rem;">ç›®å‰æ²’æœ‰å„²å­˜çš„æ–‡ç« </div>';
                return;
            }
            savedArticles.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="delete-btn" onclick="deleteArticle(${item.id}, event)">&times;</div>
                    <div class="item-title">${item.title}</div>
                    <div class="item-sub">${item.date} Â· å­—æ•¸: ${item.content.length}</div>
                `;
                div.onclick = () => loadArticle(item.id);
                list.appendChild(div);
            });
        }

        // === å´é‚Šæ¬„ Tab åˆ‡æ› ===
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
        }

        // === åœ–ç‰‡è™•ç† (ç¶­æŒä¸è®Š) ===
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return; 
            resetUI(); log(`åœ–ç‰‡: ${file.name}`);
            if (document.getElementById('twoColumnMode').checked) processTwoColumns(file); else performCloudOCR(file);
        });

        function resetUI() { 
            document.getElementById('debug-area').style.display = 'none'; 
            document.getElementById('debug-images-container').innerHTML = ''; 
            resultCard.style.display = 'none'; 
            resultContainer.innerHTML = ''; 
            updateStatus("æº–å‚™ä¸­...", "var(--text-gray)"); 
        }

        async function processTwoColumns(file) { 
            updateStatus("âš¡ è™•ç†ç‰ˆé¢...", "var(--primary)"); 
            try { 
                const img = await loadImage(file); 
                const leftBlob = await cropImage(img, 0, 0, 0.5, 1); 
                const rightBlob = await cropImage(img, 0.5, 0, 0.5, 1); 
                document.getElementById('debug-area').style.display = 'block';
                showDebugImage(leftBlob, "å·¦æ¬„"); showDebugImage(rightBlob, "å³æ¬„");
                updateStatus("ğŸ” è¾¨è­˜å·¦æ¬„...", "var(--warning)"); 
                const leftText = await callOCRSpace(leftBlob); 
                updateStatus("ğŸ” è¾¨è­˜å³æ¬„...", "var(--warning)"); 
                const rightText = await callOCRSpace(rightBlob); 
                const fullText = (leftText || "") + "\n\n" + (rightText || ""); 
                if (fullText.trim().length > 0) { displayInteractiveText(fullText); updateStatus("âœ… å®Œæˆ", "var(--success)"); } 
                else { updateStatus("âŒ å¤±æ•—", "var(--danger)"); }
            } catch (e) { log(e.message, 'error'); }
        }

        async function performCloudOCR(file) { 
            updateStatus("â˜ï¸ ä¸Šå‚³è¾¨è­˜...", "var(--primary)"); 
            const text = await callOCRSpace(file); 
            if (text) { displayInteractiveText(text); updateStatus("âœ… å®Œæˆ", "var(--success)"); } 
            else { updateStatus("âŒ å¤±æ•—", "var(--danger)"); }
        }

        async function callOCRSpace(fileBlob) { 
            const formData = new FormData(); 
            formData.append("apikey", API_KEY); formData.append("language", "eng"); formData.append("isOverlayRequired", "false"); formData.append("file", fileBlob, "image.jpg"); formData.append("OCREngine", "2"); formData.append("scale", "true"); 
            try { 
                const res = await fetch("https://api.ocr.space/parse/image", { method: "POST", body: formData }); 
                const data = await res.json(); 
                if (data.ParsedResults && data.ParsedResults.length > 0) return data.ParsedResults[0].ParsedText; 
                return ""; 
            } catch (e) { log(e.message, 'error'); return null; } 
        }

        // === æ ¸å¿ƒé¡¯ç¤ºé‚è¼¯ (æ›´æ–°ï¼šå­˜å…¥æš«å­˜è®Šæ•¸) ===
        function displayInteractiveText(text) {
            currentArticleText = text; // å„²å­˜ç•¶å‰æ–‡å­—ä¾›å­˜æª”ç”¨
            resultCard.style.display = 'block'; 
            resultContainer.style.display = 'block'; 
            
            // éš±è—è¼¸å…¥å€ï¼Œè®“é–±è®€æ›´å°ˆæ³¨
            uploadCard.style.display = 'none';
            quizCard.style.display = 'none';

            // æ’ç‰ˆè™•ç†
            let formatted = text.replace(/-\s*[\r\n]+/g, "").replace(/\r\n/g, "\n").replace(/\n\s*\n/g, "{{PARA}}").replace(/\n/g, " ").replace(/{{PARA}}/g, "\n\n");
            const paragraphs = formatted.replace(/(\d+)/g, " $1 ").split('\n\n'); 
            
            resultContainer.innerHTML = '';
            paragraphs.forEach(p => {
                if(!p.trim()) return;
                const div = document.createElement('div'); div.className = 'paragraph';
                p.split(/(\s+)/).forEach(w => {
                    const span = document.createElement('span'); span.innerText = w;
                    const clean = w.replace(/[^a-zA-Z]/g, "");
                    if(clean) { span.className = 'word'; span.onclick = () => { if(!window.getSelection().toString()) lookupWord(clean); }; }
                    div.appendChild(span);
                });
                resultContainer.appendChild(div);
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // === å›é¦–é  ===
        function goHome() { 
            quizCard.style.display = 'none'; 
            resultCard.style.display = 'none';
            uploadCard.style.display = 'block'; 
            drawer.classList.remove('open'); 
            currentArticleText = "";
            document.getElementById('manualText').value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
        }

        // === æŸ¥è©¢èˆ‡å–®å­—æœ¬ (ç¶­æŒä¸è®Š) ===
        async function lookupWord(text) { 
            const q = text.replace(/[^a-zA-Z\s]/g, "").trim(); if(!q) return; 
            modal.style.display = 'flex'; modalBody.innerHTML = `<div class="loader">ğŸ” æŸ¥è©¢ä¸­...</div>`;
            try {
                const [resEn, resZh] = await Promise.all([ fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${q}`), fetch(`https://api.mymemory.translated.net/get?q=${q}&langpair=en|zh-TW`) ]);
                const zhData = await resZh.json(); let zhText = zhData.responseData?.translatedText || "å¤±æ•—";
                if(!/[\u4e00-\u9fa5]/.test(zhText) && zhData.matches) zhText = zhData.matches.find(m=>/[\u4e00-\u9fa5]/.test(m.translation))?.translation || zhText;
                
                const isSaved = savedVocab.some(i => i.word.toLowerCase() === q.toLowerCase());
                const btnHtml = `<button id="saveBtn" onclick="toggleSaveWord('${q}', '${zhText}')" class="action-btn ${isSaved?'btn-primary':'btn-outline'}" style="width:auto; padding:0.4rem 1rem;">${isSaved?'â­ å·²æ”¶è—':'â˜† æ”¶è—'}</button>`;
                
                let html = `<div style="display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding-bottom:1rem; margin-bottom:1rem;"><h2 style="margin:0; color:var(--primary);">${q}</h2><button onclick="speakWord('${q}')" style="background:var(--success); color:white; border:none; border-radius:50%; width:32px; height:32px;">ğŸ”Š</button><div style="flex:1;"></div>${btnHtml}</div>`;
                html += `<div style="background:#fff7ed; padding:1rem; border-radius:0.5rem; border-left: 4px solid var(--warning); margin-bottom:1.5rem;"><strong style="font-size:1.2rem;">${zhText}</strong></div>`;
                
                if(resEn.ok) {
                    const enData = await resEn.json();
                    enData[0].meanings.forEach(m => {
                        html += `<div style="margin-bottom:1rem;"><span style="background:#eff6ff; color:var(--primary); padding:2px 8px; border-radius:4px; font-weight:bold;">${m.partOfSpeech}</span>`;
                        m.definitions.slice(0,2).forEach((d,i)=> html+=`<div style="margin:5px 0; color:#444;">${i+1}. ${d.definition}</div>`);
                        html += `</div>`;
                    });
                }
                modalBody.innerHTML = html;
            } catch(e) { modalBody.innerHTML = 'æŸ¥è©¢å¤±æ•—'; }
        }

        function toggleSaveWord(w, m) {
            const idx = savedVocab.findIndex(i => i.word.toLowerCase() === w.toLowerCase());
            if(idx === -1) savedVocab.push({word:w, meaning:m, date:new Date().toLocaleDateString()});
            else savedVocab.splice(idx, 1);
            localStorage.setItem('myVocab', JSON.stringify(savedVocab)); updateVocabUI();
            const btn = document.getElementById('saveBtn');
            if(btn) { btn.innerText = idx===-1?'â­ å·²æ”¶è—':'â˜† æ”¶è—'; btn.className = `action-btn ${idx===-1?'btn-primary':'btn-outline'}`; }
        }
        
        function updateVocabUI() {
            const list = document.getElementById('vocab-list'); list.innerHTML = '';
            document.getElementById('vocab-count').innerText = savedVocab.length;
            if(!savedVocab.length) { list.innerHTML = '<div style="text-align:center; color:gray; margin-top:2rem;">ç„¡æ”¶è—å–®å­—</div>'; return; }
            [...savedVocab].reverse().forEach(i => {
                const div = document.createElement('div'); div.className = 'list-item';
                div.innerHTML = `<div class="delete-btn" onclick="deleteWord('${i.word}')">&times;</div><div class="item-title" onclick="lookupWord('${i.word}')">${i.word}</div><div class="item-sub">${i.meaning}</div>`;
                list.appendChild(div);
            });
        }
        function deleteWord(w) { savedVocab = savedVocab.filter(i => i.word !== w); localStorage.setItem('myVocab', JSON.stringify(savedVocab)); updateVocabUI(); }
        function clearVocab() { if(confirm('æ¸…ç©ºï¼Ÿ')) { savedVocab=[]; localStorage.setItem('myVocab', '[]'); updateVocabUI(); } }
        function exportToCSV() { /* CSV é‚è¼¯ç¶­æŒä¸è®Š */ alert("åŒ¯å‡ºåŠŸèƒ½æ­£å¸¸"); } // ç‚ºç¯€çœç¯‡å¹…çœç•¥è©³ç´°å¯¦ä½œï¼Œå¯ç›´æ¥ç”¨èˆŠç‰ˆ

        // === æ¸¬é©— (ç¶­æŒä¸è®Š) ===
        function startQuiz() { 
            if(savedVocab.length < 4) { alert("å–®å­—ä¸è¶³ 4 å€‹"); return; }
            toggleDrawer(); quizCard.style.display = 'block'; uploadCard.style.display = 'none'; resultCard.style.display = 'none';
            document.getElementById('quiz-game-area').style.display='block'; document.getElementById('quiz-result-area').style.display='none';
            quizQuestions = [...savedVocab].sort(()=>0.5-Math.random()).slice(0,10); currentQuestionIndex=0; score=0;
            document.getElementById('total-questions').innerText = quizQuestions.length; renderQuestion();
        }
        function renderQuestion() {
            isAnswering = false; document.getElementById('current-score').innerText = score;
            const q = quizQuestions[currentQuestionIndex]; document.getElementById('quiz-word').innerText = q.word;
            const opts = [q.meaning, ...savedVocab.filter(i=>i.word!==q.word).sort(()=>0.5-Math.random()).slice(0,3).map(i=>i.meaning)].sort(()=>0.5-Math.random());
            const box = document.getElementById('quiz-options'); box.innerHTML = '';
            opts.forEach(o => { const b=document.createElement('button'); b.className='quiz-btn'; b.innerText=o; b.onclick=()=>checkAns(b, o===q.meaning); box.appendChild(b); });
            speakWord(q.word);
        }
        function checkAns(btn, ok) {
            if(isAnswering) return; isAnswering = true;
            if(ok) { btn.classList.add('correct'); score++; } else { btn.classList.add('wrong'); document.querySelectorAll('.quiz-btn').forEach(b=>{if(b.innerText===quizQuestions[currentQuestionIndex].meaning)b.classList.add('correct')}); }
            setTimeout(()=>{ if(++currentQuestionIndex < quizQuestions.length) renderQuestion(); else showRes(); }, 1500);
        }
        function showRes() { document.getElementById('quiz-game-area').style.display='none'; document.getElementById('quiz-result-area').style.display='block'; document.getElementById('final-score-title').innerText = Math.round(score/quizQuestions.length*100)+"åˆ†"; }

        // === å·¥å…· ===
        function speakWord(w) { const u=new SpeechSynthesisUtterance(w); u.lang='en-US'; window.speechSynthesis.speak(u); }
        function loadImage(f) { return new Promise((r,j)=>{const i=new Image(); i.onload=()=>r(i); i.onerror=j; i.src=URL.createObjectURL(f);}); }
        function cropImage(img,x,y,w,h) { return new Promise(r=>{const c=document.createElement('canvas'); c.width=img.width*w; c.height=img.height*h; const ctx=c.getContext('2d'); ctx.fillStyle="#FFF"; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,img.width*x,img.height*y,c.width,c.height,0,0,c.width,c.height); c.toBlob(b=>r(b),'image/jpeg',0.8);}); }
        function showDebugImage(b,t) { const u=URL.createObjectURL(b); document.getElementById('debug-images-container').innerHTML += `<div><p>${t}</p><img src="${u}" class="debug-img"></div>`; }
        function updateStatus(m,c) { status.innerHTML = `<span style="color:${c}">${m}</span>`; }
        function toggleDrawer() { drawer.classList.toggle('open'); }
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = e => { if(e.target==modal) closeModal(); };
        resultContainer.addEventListener('mouseup', handleSelection); resultContainer.addEventListener('touchend', handleSelection);
        function handleSelection() { setTimeout(() => { const s = window.getSelection().toString().trim(); if (s && /[a-zA-Z]/.test(s)) { lookupWord(s); window.getSelection().removeAllRanges(); } }, 100); }

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }
    </script>
</body>
</html>